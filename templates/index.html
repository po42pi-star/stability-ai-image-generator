<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Image Generator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>üé® AI Image Generator</h1>
            <p class="subtitle">GigaChat + Stability AI</p>
        </header>

        <main>
            <!-- –§–æ—Ä–º–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ -->
            <div class="generator-form">
                <div class="form-group">
                    <label for="prompt">–í–∞—à –ø—Ä–æ–º–ø—Ç:</label>
                    <textarea 
                        id="prompt" 
                        placeholder="–û–ø–∏—à–∏—Ç–µ, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–≤–∏–¥–µ—Ç—å... –ù–∞–ø—Ä–∏–º–µ—Ä: –∫–æ—Ç—ã –≤ –¥–µ–ª–æ–≤—ã—Ö –∫–æ—Å—Ç—é–º–∞—Ö –Ω–∞ —Å–æ–≤–µ—Ç–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–æ–≤"
                        rows="3"
                    ></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group half">
                        <label for="style">–°—Ç–∏–ª—å:</label>
                        <select id="style">
                            {% for key, style in styles.items() %}
                            <option value="{{ key }}">{{ style.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group half">
                        <label for="size">–†–∞–∑–º–µ—Ä:</label>
                        <select id="size">
                            <option value="1024,1024">1024 √ó 1024 (1:1)</option>
                            <option value="1280,720">1280 √ó 720 (16:9)</option>
                            <option value="720,1280">720 √ó 1280 (9:16)</option>
                            <option value="1024,768">1024 √ó 768 (4:3)</option>
                            <option value="768,1024">768 √ó 1024 (3:4)</option>
                        </select>
                    </div>
                </div>

                <div class="form-group checkbox-group">
                    <label>
                        <input type="checkbox" id="improve" checked>
                        –£–ª—É—á—à–∏—Ç—å –ø—Ä–æ–º–ø—Ç —á–µ—Ä–µ–∑ GigaChat
                    </label>
                </div>

                <button id="generateBtn" onclick="startGeneration()">
                    <span class="btn-text">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</span>
                    <span class="btn-loading" style="display: none;">‚è≥ –ò–¥—ë—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏—è...</span>
                </button>
            </div>

            <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä -->
            <div id="progressSection" class="progress-section" style="display: none;">
                <div class="progress-header">
                    <span class="progress-text" id="progressText">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...</span>
                    <span class="close-btn" onclick="closeProgress()">&times;</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>

            <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç —Å –ø—Ä–æ–º–ø—Ç–∞–º–∏ -->
            <div id="resultSection" class="result-section" style="display: none;">
                <div class="result-header">
                    <h2>‚ú® –†–µ–∑—É–ª—å—Ç–∞—Ç</h2>
                    <span class="close-btn large" onclick="closeResult()">&times;</span>
                </div>
                
                <!-- –ü—Ä–æ–º–ø—Ç—ã -->
                <div class="prompts-comparison">
                    <div class="prompt-box original">
                        <div class="prompt-label">üìù –ò—Å—Ö–æ–¥–Ω—ã–π –ø—Ä–æ–º–ø—Ç:</div>
                        <div class="prompt-text" id="originalPrompt"></div>
                    </div>
                    <div class="prompt-arrow">‚¨áÔ∏è</div>
                    <div class="prompt-box improved">
                        <div class="prompt-label">üöÄ –£–ª—É—á—à–µ–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç (GigaChat):</div>
                        <div class="prompt-text" id="improvedPrompt"></div>
                    </div>
                </div>
                
                <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ -->
                <div id="imageContainer" class="image-grid"></div>
            </div>

            <!-- –ì–∞–ª–µ—Ä–µ—è -->
            <div class="gallery-section">
                <h2>üìÅ –í—Å–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</h2>
                <div class="gallery-grid" id="galleryGrid">
                    {% for img in existing_images %}
                    <div class="gallery-item" onclick="showImageDetails('{{ img.name }}')">
                        <img src="{{ img.path }}" alt="{{ img.prompt }}">
                        <div class="gallery-caption">{{ img.prompt }}</div>
                        {% if img.style %}
                        <div class="gallery-style">{{ img.style }}</div>
                        {% endif %}
                    </div>
                    {% else %}
                    <p class="empty-gallery">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç. –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –ø–µ—Ä–≤–æ–µ!</p>
                    {% endfor %}
                </div>
            </div>
        </main>

        <footer>
            <p>Powered by GigaChat + Stability AI</p>
        </footer>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π -->
    <div id="imageModal" class="modal" style="display: none;" onclick="closeModal(event)">
        <div class="modal-content">
            <span class="close-btn modal-close" onclick="closeModalOnly()">&times;</span>
            <div class="modal-image-container">
                <img id="modalImage" src="" alt="">
            </div>
            <div class="modal-prompts" id="modalPrompts"></div>
        </div>
    </div>

    <script>
        let currentTaskId = null;
        let pollInterval = null;

        async function startGeneration() {
            const prompt = document.getElementById('prompt').value.trim();
            const style = document.getElementById('style').value;
            const size = document.getElementById('size').value.split(',');
            const improve = document.getElementById('improve').checked;

            if (!prompt) {
                alert('–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–ø—Ç!');
                return;
            }

            // UI —Å–æ—Å—Ç–æ—è–Ω–∏–µ - –∑–∞–≥—Ä—É–∑–∫–∞
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('generateBtn').querySelector('.btn-text').style.display = 'none';
            document.getElementById('generateBtn').querySelector('.btn-loading').style.display = 'inline';
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('resultSection').style.display = 'none';
            
            updateProgress(10, '–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞...');

            try {
                const response = await fetch('/generate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        prompt: prompt,
                        style: style,
                        improve: improve,
                        width: parseInt(size[0]),
                        height: parseInt(size[1])
                    })
                });

                const data = await response.json();
                console.log('Task ID:', data.task_id);

                if (data.error) {
                    throw new Error(data.error);
                }

                currentTaskId = data.task_id;
                startPolling();

            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
                resetUI();
            }
        }

        function startPolling() {
            pollInterval = setInterval(checkStatus, 1500);
        }

        async function checkStatus() {
            if (!currentTaskId) return;

            try {
                const response = await fetch('/status/' + currentTaskId);
                const data = await response.json();
                console.log('Status:', data.status, data.message);

                updateProgressFromStatus(data);

                if (data.status === 'completed' || data.status === 'error') {
                    clearInterval(pollInterval);
                    showResult(data);
                    resetUI();
                }

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞:', error);
            }
        }

        function updateProgress(percent, message) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = message;
        }

        function updateProgressFromStatus(data) {
            let percent = 0;
            let message = data.message || '';

            switch (data.status) {
                case 'starting': percent = 10; break;
                case 'improving_prompt': percent = 30; break;
                case 'generating': percent = 60; break;
                case 'saving': percent = 85; break;
                case 'completed': percent = 100; break;
                case 'error': percent = 100; break;
            }

            updateProgress(percent, message);
        }

        function closeProgress() {
            document.getElementById('progressSection').style.display = 'none';
            if (pollInterval) clearInterval(pollInterval);
        }

        function closeResult() {
            document.getElementById('resultSection').style.display = 'none';
            currentTaskId = null;
        }

        function showResult(data) {
            const resultSection = document.getElementById('resultSection');
            const imageContainer = document.getElementById('imageContainer');
            const originalPromptEl = document.getElementById('originalPrompt');
            const improvedPromptEl = document.getElementById('improvedPrompt');

            resultSection.style.display = 'block';
            imageContainer.innerHTML = '';

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–º–ø—Ç—ã
            originalPromptEl.textContent = data.original_prompt || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
            improvedPromptEl.textContent = data.improved_prompt || data.prompt || '–ë–µ–∑ —É–ª—É—á—à–µ–Ω–∏—è';

            if (data.status === 'completed' && data.images && data.images.length > 0) {
                data.images.forEach((imgBase64, index) => {
                    const img = document.createElement('div');
                    img.className = 'result-image highlighted';
                    img.innerHTML = `
                        <div class="result-badge">‚ú® –ù–û–í–û–ï</div>
                        <img src="${imgBase64}" alt="–†–µ–∑—É–ª—å—Ç–∞—Ç ${index + 1}">
                        <div class="image-actions">
                            <a href="${imgBase64}" download="image_${index + 1}.png" class="download-btn">‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å</a>
                        </div>
                    `;
                    imageContainer.appendChild(img);
                });

                resultSection.scrollIntoView({ behavior: 'smooth' });

            } else {
                improvedPromptEl.innerHTML = '<span style="color: #ff6b6b;">' + (data.error || data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</span>';
            }
        }

        async function showImageDetails(name) {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const response = await fetch('/api/images');
            const images = await response.json();
            
            const imgData = images.find(img => img.name === name);
            if (!imgData) return;

            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            const modalPrompts = document.getElementById('modalPrompts');

            modalImg.src = imgData.path;
            modalPrompts.innerHTML = `
                <div class="prompt-box original">
                    <div class="prompt-label">üìù –ò—Å—Ö–æ–¥–Ω—ã–π:</div>
                    <div class="prompt-text">${imgData.original_prompt || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}</div>
                </div>
                <div class="prompt-box improved">
                    <div class="prompt-label">üöÄ –£–ª—É—á—à–µ–Ω–Ω—ã–π:</div>
                    <div class="prompt-text">${imgData.improved_prompt || imgData.prompt || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}</div>
                </div>
                ${imgData.style ? `<div class="prompt-style">üé® –°—Ç–∏–ª—å: ${imgData.style}</div>` : ''}
            `;

            modal.style.display = 'flex';
        }

        function closeModalOnly() {
            document.getElementById('imageModal').style.display = 'none';
        }

        function closeModal(event) {
            if (event.target === document.getElementById('imageModal')) {
                closeModalOnly();
            }
        }

        function resetUI() {
            document.getElementById('generateBtn').disabled = false;
            document.getElementById('generateBtn').querySelector('.btn-text').style.display = 'inline';
            document.getElementById('generateBtn').querySelector('.btn-loading').style.display = 'none';
            currentTaskId = null;
            if (pollInterval) clearInterval(pollInterval);
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        window.onclick = function(event) {
            const modal = document.getElementById('imageModal');
            if (event.target === modal) {
                closeModalOnly();
            }
        }

        // ESC –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModalOnly();
                closeResult();
                closeProgress();
            }
        });

        // Ctrl+Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
        document.getElementById('prompt').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && e.ctrlKey) {
                startGeneration();
            }
        });
    </script>
</body>
</html>